<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>è¨ªå®¢ç•™è¨€ç‰ˆ (RESTful + Gson)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css">
    <style>
        #editModal {
            display: none;
            position: fixed;
            left: 50%;
            top: 30%;
            transform: translate(-50%, 0);
            background: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            z-index: 1000;
        }
        #modalBackdrop {
            display: none;
            position: fixed;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.2);
            z-index: 999;
        }
    </style>
</head>
<body style="padding: 20px">
<h2>è¨ªå®¢ç•™è¨€ (RESTful + Gson)</h2>
<form id="addForm" class="pure-form">
    <fieldset>
        æš±ç¨±: <input type="text" name="name" required />
        ç•™è¨€: <input type="text" name="message" required />
        <button type="submit" class="pure-button pure-button-primary">é€å‡º</button>
    </fieldset>
</form>
<div style="margin-top:20px;">
    <fieldset>
        <legend>ç•™è¨€ç´€éŒ„</legend>
        <table class="pure-table" id="guestbookTable">
            <thead>
                <tr>
                    <th>åºè™Ÿ</th><th>æš±ç¨±</th><th>ç•™è¨€</th><th>æ™‚é–“</th><th>åˆªé™¤</th><th>ä¿®æ”¹</th>
                </tr>
            </thead>
            <tbody>
                <!-- å‹•æ…‹ç”¢ç”Ÿ -->
            </tbody>
        </table>
    </fieldset>
</div>

<!--
ç•¶ä½ æ‰“é–‹ã€Œç·¨è¼¯ç•™è¨€ã€çš„å½ˆå‡ºè¦–çª—ï¼ˆModalï¼‰æ™‚ï¼Œ
é€™å€‹ backdrop æœƒé¡¯ç¤ºåœ¨æ•´å€‹ç•«é¢ä¸Šï¼Œ
è®“èƒŒæ™¯è®Šæš—ã€ä¸å¯é»æ“Šï¼Œ
å¼·èª¿å½ˆçª—å…§å®¹ï¼Œä¸¦é˜²æ­¢ä½¿ç”¨è€…èª¤æ“ä½œèƒŒæ™¯ã€‚
 -->
<div id="modalBackdrop"></div>
<div id="editModal">
    <form id="editForm" class="pure-form">
        <input type="hidden" name="id" />
        æš±ç¨±: <input type="text" name="name" required /><br/>
        ç•™è¨€: <input type="text" name="message" required /><br/>
        <button type="submit" class="pure-button pure-button-primary">ä¿®æ”¹</button>
        <button type="button" onclick="closeModal()" class="pure-button">å–æ¶ˆ</button>
    </form>
</div>

<script>
const apiBase = '/JavaWeb/api/guestbook';

function fetchGuestbooks() {
    fetch(apiBase)
        .then(res => res.json())
        .then(data => {
            const tbody = document.querySelector('#guestbookTable tbody');
            tbody.innerHTML = '';
            data.forEach(gb => {
                tbody.innerHTML += `
                <tr>
                    <td>${gb.id}</td>
                    <td>${gb.name}</td>
                    <td>${gb.message}</td>
                    <td>${gb.createAt ? gb.createAt.replace('T', ' ').substring(0, 19) : ''}</td>
                    <td><button onclick="deleteGuestbook(${gb.id})">âœ‚</button></td>
                    <td><button onclick="showEditModal(${gb.id}, '${escapeHtml(gb.name)}', '${escapeHtml(gb.message)}')">ğŸ“</button></td>
                </tr>
                `;
            });
        });
}
fetchGuestbooks();

document.getElementById('addForm').onsubmit = function(e) {
    e.preventDefault();
    const form = e.target;
    const data = {
        name: form.name.value,
        message: form.message.value
    };
    fetch(apiBase, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).then(() => {
        form.reset();
        fetchGuestbooks();
    });
};

function deleteGuestbook(id) {
    if (confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) {
        fetch(apiBase + '/' + id, {method: 'DELETE'})
            .then(() => fetchGuestbooks());
    }
}

function showEditModal(id, name, message) {
    const modal = document.getElementById('editModal');
    const backdrop = document.getElementById('modalBackdrop');
    modal.style.display = 'block';
    backdrop.style.display = 'block';
    modal.querySelector('input[name="id"]').value = id;
    modal.querySelector('input[name="name"]').value = unescapeHtml(name);
    modal.querySelector('input[name="message"]').value = unescapeHtml(message);
}

function closeModal() {
    document.getElementById('editModal').style.display = 'none';
    document.getElementById('modalBackdrop').style.display = 'none';
}

document.getElementById('editForm').onsubmit = function(e) {
    e.preventDefault();
    const form = e.target;
    const id = form.id.value;
    const data = {
        name: form.name.value,
        message: form.message.value
    };
    fetch(apiBase + '/' + id, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).then(() => {
        closeModal();
        fetchGuestbooks();
    });
};

// é˜²æ­¢ XSS
function escapeHtml(text) {
    return text.replace(/[&<>"']/g, function(m) {
        return ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        })[m];
    });
}
function unescapeHtml(text) {
    return text.replace(/&amp;|&lt;|&gt;|&quot;|&#39;/g, function(m) {
        return ({
            '&amp;': '&',
            '&lt;': '<',
            '&gt;': '>',
            '&quot;': '"',
            '&#39;': "'"
        })[m];
    });
}
</script>
</body>
</html>
